{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "title": "Monthly Temperature Candlestick (2011–2017)",
  "width": 600,
  "height": 420,
  "params": [
    {
      "name": "year_select",
      "value": 2017,
      "bind": {"input": "range", "min": 2011, "max": 2017, "step": 1, "name": "Year: "}
    }
  ],
  "data": {
    "url": "https://gist.githubusercontent.com/qhoa0005/03216fd6f5d4e9f252df8fe4ebca1fe7/raw/d08adae7500d1310c6dd914b09b3d8313e5dfd23/monthly_min_max_temperature_2011_2017.csv",
    "format": {"type": "csv"}
  },
  "transform": [
    {"filter": "toNumber(datum.year) == year_select"},
    {"calculate": "toNumber(datum.month)", "as": "MonthNum"},
    {"calculate": "toNumber(datum.monthly_min_temp)", "as": "minT"},
    {"calculate": "toNumber(datum.monthly_max_temp)", "as": "maxT"},
    {"calculate": "(datum.minT + datum.maxT) / 2", "as": "median"},

    {"window": [{"op": "lag", "field": "median", "as": "median_prev"}],
     "sort": [{"field": "MonthNum", "order": "ascending"}]},
    {"calculate": "isValid(datum.median_prev) ? datum.median_prev : datum.median", "as": "open_real"},
    {"calculate": "datum.median", "as": "close_real"},
    {"calculate": "datum.close_real >= datum.open_real ? 1 : 0", "as": "trendUp"},

    {"calculate": "datum.median - 1", "as": "open"},
    {"calculate": "datum.median + 1", "as": "close"},

    {"calculate": "['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][datum.MonthNum-1]", "as": "MonthName"}
  ],
  "layer": [
    {
      "mark": {"type": "rule", "strokeWidth": 1.5},
      "encoding": {
        "x": {
          "field": "MonthName",
          "type": "ordinal",
          "title": "Month",
          "sort": ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]
        },
        "y": {"field": "minT", "type": "quantitative", "title": "Temperature (°C)"},
        "y2": {"field": "maxT"},
        "color": {
          "condition": {"test": "datum.trendUp == 1", "value": "#2ca02c"},
          "value": "#d62728"
        },
        "tooltip": [
          {"field": "year", "title": "Year"},
          {"field": "MonthName", "title": "Month"},
          {"field": "minT", "title": "Min (°C)"},
          {"field": "maxT", "title": "Max (°C)"},
          {"field": "open_real", "title": "Open (prev median °C)"},
          {"field": "close_real", "title": "Close (median °C)"}
        ]
      }
    },
    {
      "mark": {"type": "bar", "size": 18, "strokeWidth": 1},
      "encoding": {
        "x": {
          "field": "MonthName",
          "type": "ordinal",
          "sort": ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]
        },
        "y": {"field": "open", "type": "quantitative"},
        "y2": {"field": "close"},
        "color": {
          "condition": {"test": "datum.trendUp == 1", "value": "#2ca02c"},
          "value": "#d62728"
        },
        "stroke": {
          "condition": {"test": "datum.trendUp == 1", "value": "#2ca02c"},
          "value": "#d62728"
        },
        "tooltip": [
          {"field": "median", "title": "Median (°C)"},
          {"field": "open_real", "title": "Open (prev median °C)"},
          {"field": "close_real", "title": "Close (median °C)"}
        ]
      }
    }
  ]
}
